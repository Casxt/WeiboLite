# 微博Lite
一个简易版微博
- [微博Lite](#%E5%BE%AE%E5%8D%9Alite)
    - [数据库说明](#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AF%B4%E6%98%8E)
        - [模型](#%E6%A8%A1%E5%9E%8B)
        - [账户功能](#%E8%B4%A6%E6%88%B7%E5%8A%9F%E8%83%BD)
            - [需求：邮件注册，登录、退出，修改密码，重置密码](#%E9%9C%80%E6%B1%82%EF%BC%9A%E9%82%AE%E4%BB%B6%E6%B3%A8%E5%86%8C%EF%BC%8C%E7%99%BB%E5%BD%95%E3%80%81%E9%80%80%E5%87%BA%EF%BC%8C%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81%EF%BC%8C%E9%87%8D%E7%BD%AE%E5%AF%86%E7%A0%81)
            - [数据库设计](#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1)
        - [发布消息](#%E5%8F%91%E5%B8%83%E6%B6%88%E6%81%AF)
            - [需求：可以发布消息，可以附带图片和链接。会出现在消息列表上，也出现在关注者的消息列表上](#%E9%9C%80%E6%B1%82%EF%BC%9A%E5%8F%AF%E4%BB%A5%E5%8F%91%E5%B8%83%E6%B6%88%E6%81%AF%EF%BC%8C%E5%8F%AF%E4%BB%A5%E9%99%84%E5%B8%A6%E5%9B%BE%E7%89%87%E5%92%8C%E9%93%BE%E6%8E%A5%E3%80%82%E4%BC%9A%E5%87%BA%E7%8E%B0%E5%9C%A8%E6%B6%88%E6%81%AF%E5%88%97%E8%A1%A8%E4%B8%8A%EF%BC%8C%E4%B9%9F%E5%87%BA%E7%8E%B0%E5%9C%A8%E5%85%B3%E6%B3%A8%E8%80%85%E7%9A%84%E6%B6%88%E6%81%AF%E5%88%97%E8%A1%A8%E4%B8%8A)
            - [数据库设计](#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1)
        - [最热消息](#%E6%9C%80%E7%83%AD%E6%B6%88%E6%81%AF)
        - [消息详情](#%E6%B6%88%E6%81%AF%E8%AF%A6%E6%83%85)
        - [用户搜索](#%E7%94%A8%E6%88%B7%E6%90%9C%E7%B4%A2)
        - [我的关注/关注我的人](#%E6%88%91%E7%9A%84%E5%85%B3%E6%B3%A8%E5%85%B3%E6%B3%A8%E6%88%91%E7%9A%84%E4%BA%BA)
        - [用户详情](#%E7%94%A8%E6%88%B7%E8%AF%A6%E6%83%85)
    - [登陆注册流程安全保障说明](#%E7%99%BB%E9%99%86%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B%E5%AE%89%E5%85%A8%E4%BF%9D%E9%9A%9C%E8%AF%B4%E6%98%8E)
        - [注册](#%E6%B3%A8%E5%86%8C)
        - [登陆](#%E7%99%BB%E9%99%86)
        - [备注](#%E5%A4%87%E6%B3%A8)

## 数据库说明
### 模型
![img](http://ima.forer.cn/WeiboLiteModel.PNG)
### 账户功能
#### 需求：邮件注册，登录、退出，修改密码，重置密码
1. 登陆流程：输入用户名、邮件地址和密码，系统发送激活邮件，登录的状态可以保存
2. 重置密码流程：未登录情况下可以重置密码，输入邮件地址，发送重置密码链接到邮箱，点击链接给重置密码的页面，重置密码的链接24小时失效。
3. 修改密码流程：需输入老密码确认
4. 账户设置：登录后可以上传头像，编写自己的自我简介，允许用户删除自己的账户

#### 数据库设计
1. 未激活用户 -> UnconfirmedUser:
   
   包含用户名，邮箱，密码，激活码，有效日期，激活账户时相关信息转移至正式用户表

2. 已激活用户 -> User:
   
   包含用户名，邮箱，Salt，Hash密码，头像链接，简介，激活日期

3. 重置密码库 -> ResetPass:

    包含用户名，重置码，申请日期

4. 用户Session:
   这部分考虑直接使用map实现

### 发布消息

#### 需求：可以发布消息，可以附带图片和链接。会出现在消息列表上，也出现在关注者的消息列表上

#### 数据库设计

1. 消息 -> WeiBo:
   
   包含发布者，内容，图片（的hash值），转发类型，转发源，时间

   链接和转发在消息创建时就会以特定格式记录于内容中，被转发一项记录哪些消息转发了该条消息，这样设计的目的是便于查询和计数

2. 评论 -> Comment:
   
   包含发布者，对应于哪条消息，内容，时间

3. 图片 -> Image:
   
   包含，图片hash，所属用户，存储路径，尺寸，大小，引用计数，上传时间

   建议直接使用hash作为图片文件名，以节省存储空间

4. 关注 -> Follow:

    包含用户，关注者，时间

消息列表以隐含方式实现，用户访问其消息页面时，将同时展示其自己和其关注的用户消息，对于其消息的转发将显示在这条消息下发。

### 最热消息

统计各项信息即可，暂无特殊设计，由专门页面进行展示

### 消息详情
此项属于UI部分

### 用户搜索
直接在 User 表中模糊匹配

### 我的关注/关注我的人
直接在Follow表中查询即可

### 用户详情
直接查询User表

## 登陆注册流程安全保障说明

### 注册
1. 用户输入密码，得到Pass
2. 在前端sha256摘要Pass，得到HashPas
3. HashPass传回后端
4. 后端生成Salt,拼接Salt与HashPass得到SaltHashPass
5. 在后端sha256摘要SaltHashPass，得到HashSaltHashPass
6. 记录Salt 和 HashSaltHashPass与数据库
   
### 登陆
1. 用户输入密码，得到Pass，sha256摘要Pass，得到HashPas
2. 从服务端获取Random和该用户的Salt
3. 拼接Salt与HashPass并sha256后，得到HashSaltHashPass
4. HashSaltHashPass 做密钥，并生成随机IV，使用AES-256-GCM模式加密Random，得到EncryptedRandom
5. 回传EncryptedRandom和IV
6. 后端使用数据库中的HashSaltHashPass和IV对EncryptedRandom进行解密并验证，如果成功，且random相同，则登陆成功。

### 备注
虽然流程显得非常复杂，但是这个模式可以最大限度的保证用户密码安全，并且在整个流程中，用户密码都没有离开本地，在除了注册的过程中，没有直接的鉴权数据经过网络。即使网络不可靠，或者数据库被攻击的情况下依旧能保证密码安全。